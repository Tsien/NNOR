%Author: Tsien at NUAA, China. 05/10/2015
%This is the main function of the whole project
%The dataset contains one variable, called data. The last column of 
%data is the label. 

% Parameters of the function:
% --------------------------
% datafile: contains label in its last column
% 
% Returns:
% -------
% W   : weights of neural network.
% MAE : Mean Absolute Error of the whole system.
%
% ===================================================================================================
function [W, MAE] = MSEB(datafile)
    load(datafile);
    [num, dim] = size(data);
    index = randperm(num);
    train_num = ceil(num * 0.8);
    
    train_x = data(index(1:train_num), 1 : end - 1);
    train_y = data(index(1:train_num), end);
    test_x = data(index(train_num + 1:end), 1 : end - 1);
    test_y = data(index(train_num + 1:end), end);
    %======================================================
    % normalize   
    [train_x, mu, sigma] = zscore(train_x);
    test_x = normalize(test_x, mu, sigma);
    train_y = rangeT
    
    %======================================================
    yd = size(train_y, 2);
    for j = 1 : yd
        [A,b,W(:, j)] = nnopt2(train_x, train_y(:, j), @ilogsig, @dlogsig_m);
    end

    [test_num, dim] = size(test_x);
     out = feval( @logsig_m , [ones(test_num, 1) test_x]*W ) ;

    %======================================================
    %Ordinal Regression
    ymax = max(test_y);
    ot = zeros(test_num, 1);
    for i = 1 : test_num
        pos = find(out(i, :) < 0.5);
        if isempty(pos)
            ot(i) = ymax;
        else
            ot(i) = pos(1) - 1;
        end
    end
    MAE = sum(abs(ot - test_y)) / test_num;    
    disp([' MAE:' num2str(MAE)]);
    %======================================================

end

