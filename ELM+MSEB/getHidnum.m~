%Author: Tsien at NUAA, China. 05/08/2015
%This is the main function of the whole project
%The dataset contains one variable, called data. The last column of 
%data is the label. 

% Parameters of the function:
% --------------------------
% data: contains label in its last column
% K   : K fold cross validation, K = 1 means no CV.
% P   : try to ensemble P ELMs
% 
% Returns:
% -------
% W   : weights of every eELM.
% MAE : Mean Absolute Error of the whole system.
%
% ===================================================================================================

function hidnum = getHidnum(k, train_x, train_y, trainY, alph)
    [num, x_dim] = size(train_x);
    [num, y_dim] = size(train_y);
    hidnum = zeros(3, 1);
    hidnum(1) = ceil(sqrt(x_dim + y_dim) + alph);%alph is in the range of [1, 10]
    hidnum(2) = ceil(log(x_dim) / log(2));
    hidnum(3) = ceil(sqrt(x_dim * y_dim));
    
    vali_num = ceil(num / k);
    train_num = num - vali_num;
    MAE = zeros(k, 1);
    for h = 1 : 3
        for i = 1 : k
            j = i * vali_num;
            vali_x = train_x(j - vali_num + 1 : min(j, end), :);
            vali_y = train_y(j - vali_num + 1 : min(j, end), :);
            valiY = trainY(j - vali_num + 1 : min(j, end));
            if i == 1
                cv_train_x = train_x(vali_num + 1 : end, :);
                cv_train_y = train_y(vali_num + 1 : end, :);
                cv_trainY = trainY(vali_num + 1 : end);
            else
                if i == K
                    cv_train_x = train_x(1 : j - vali_num, :);
                    cv_train_y = train_y(1 : j - vali_num, :);
                    cv_trainY = trainY(1 : j - vali_num);
                else
                    cv_train_x = [train_x(1 : j - vali_num, :); train_x(j + 1 : end, :)];
                    cv_train_y = [train_y(1 : j - vali_num, :); train_y(j + 1 : end, :)];
                    cv_trainY = [trainY(1 : j - vali_num); trainY(j + 1 : end)];
                end
            end
            [cv_W{i}, cv_MAE(i)] = elMseb(cv_train_x, cv_train_y, cv_trainY, hidnum(h));
            vali_MAE(i) = calMAE(cv_W{i}, vali_x, valiY);
        end
    end

end